<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikacja do zapisÃ³w na zajÄ™cia dodatkowe</title>
  <?!= include('style') ?>
</head>
<body>
  <div class="container mt-3">
    <h1>ğŸ“‹ Lista zajÄ™Ä‡ dodatkowych</h1>
    <div id="container">Åadowanie zajÄ™Ä‡...</div>
  </div>

  <script>
    // Pobranie danych z Apps Script
    google.script.run.withSuccessHandler(render).getZajeciaList();

    function render(data) {
      const container = document.getElementById('container');
      container.innerHTML = ''; // czyÅ›cimy napis "Åadowanie"

      if (!data || data.length === 0) {
        container.textContent = 'Brak zajÄ™Ä‡ do wyÅ›wietlenia.';
        return;
      }

      const refreshBtn = document.createElement('button');
        refreshBtn.textContent = 'ğŸ”„ OdÅ›wieÅ¼ listÄ™';
        refreshBtn.onclick = () => {
          container.innerHTML = 'OdÅ›wieÅ¼anie...';
          google.script.run.withSuccessHandler(render).getZajeciaList();
        };
        container.appendChild(refreshBtn);

      // Grupowanie zajÄ™Ä‡ po dniach
      const grouped = {};
      data.forEach(z => {
        if (!grouped[z.dzien]) grouped[z.dzien] = [];
        grouped[z.dzien].push(z);
      });

      Object.keys(grouped).forEach(dzien => {
        const daySection = document.createElement('div');
        daySection.className = 'day-section';

        const title = document.createElement('h2');
        title.textContent = dzien;
        daySection.appendChild(title);

        const grid = document.createElement('div');
        grid.className = 'grid';

        grouped[dzien].forEach(z => {
          const card = document.createElement('div');
          card.className = 'card';
          const content = document.createElement('div');
          content.className = 'card-content';
          content.innerHTML = `
            <h3>${z.nazwa}</h3>
            <p><strong>â°</strong> ${z.godzina_od} â€“ ${z.godzina_do}</p>
            <p><strong>ğŸ“ Klasa:</strong> ${z.klasa}</p>
            <p><strong>IloÅ›Ä‡ dostÄ™pnych miejsc:</strong> ${z.ileDostepnych}</p>
            <p class='invisible'>max: ${z.max_limit} min:${z.min_limit} ile: ${z.ileZapisanych} </p>
            <p class="${z.czyUruchomione ? 'run' : 'not_run'}">
              ${z.czyUruchomione ? 'ZajÄ™cie zostanie uruchomione': 'Brak minimalnej iloÅ›ci uczestnikÃ³w'}
            </p>
            <p class="${z.platne ? 'paid' : 'free'}">
              ${z.platne ? 'ğŸ’° PÅ‚atne' : 'âœ… BezpÅ‚atne'}
            </p>
          `;
          card.appendChild(content);
          grid.appendChild(card);
        
          const button = document.createElement('button');
          button.textContent = z.ileDostepnych > 0 ? 'âœ… Zapisz dziecko' : 'âŒ Brak miejsc';
          button.disabled = z.ileDostepnych <= 0;
          button.className = z.ileDostepnych > 0 ? '' : 'disabled';
          if (z.ileDostepnych > 0) {
          button.onclick = () => openDrawer(z);
          }
          card.appendChild(button);
         });

        daySection.appendChild(grid);
        container.appendChild(daySection);
      });
    }

    // Funkcja do pokazywania komunikatÃ³w
    function showMessage(msg, color = 'green') {
      const oldMsg = document.getElementById('custom-message');
      if (oldMsg) oldMsg.remove();

      const div = document.createElement('div');
      div.id = 'custom-message';
      div.style.position = 'fixed';
      div.style.bottom = '20px';
      div.style.right = '20px';
      div.style.background = color;
      div.style.color = 'white';
      div.style.padding = '15px 20px';
      div.style.borderRadius = '8px';
      div.style.boxShadow = '0 0 10px rgba(0,0,0,0.3)';
      div.style.zIndex = 2000;
      div.textContent = msg;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }



    // Funkcja drawer ---------------- formularz do zapisow ---------------
    function openDrawer(zajecie) {
      const overlay = document.createElement('div');
      overlay.className = 'drawer-overlay active';

      const drawer = document.createElement('div');
      drawer.className = 'drawer open';
     drawer.innerHTML = `
      <h3>Zapis na: ${zajecie.nazwa}</h3>
      
      <label>ImiÄ™ i nazwisko dziecka
        <input type="text" id="uczen" required maxlength="50">
      </label>
      
      <label>Klasa
        <input type="number" id="klasa" required min="1" max="8" step="1">
      </label>
      
      <label>ImiÄ™ i nazwisko rodzica
        <input type="text" id="rodzic" required required maxlength="50">
      </label>
      
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button id="submitForm" style="background: #1976d2; flex: 1;">âœ… Zapisz</button>
        <button id="cancelForm" style="background: #aaa; flex: 1;">âŒ Anuluj</button>
      </div>
    `;
      document.body.appendChild(overlay);
      document.body.appendChild(drawer);
      overlay.onclick = () => { drawer.remove(); overlay.remove(); };
      
      const submitBtn = document.getElementById('submitForm');
      const cancelBtn = document.getElementById('cancelForm');

      cancelBtn.onclick = () => { 
        drawer.remove(); overlay.remove();
        google.script.run.withSuccessHandler(render).getZajeciaList();
        };
     
      submitBtn.onclick = () => {  // START-----
      const uczenEl = document.getElementById('uczen');
      const klasaEl = document.getElementById('klasa');
      const rodzicEl = document.getElementById('rodzic');

      [uczenEl, klasaEl, rodzicEl].forEach(el => el.classList.remove('input-error'));

      const uczen = uczenEl.value.trim();
      const klasaStr = klasaEl.value.trim();
      const rodzic = rodzicEl.value.trim();

      let hasError = false;

      if (!uczen || uczen.length < 3 || uczen.length > 50) {
        uczenEl.classList.add('input-error');
        hasError = true;
      }
      if (!rodzic || rodzic.length < 3 || rodzic.length > 50) {
        rodzicEl.classList.add('input-error');
        hasError = true;
      }
      const klasaNum = parseInt(klasaStr, 10);
      if (isNaN(klasaNum) || klasaNum < 1 || klasaNum > 8) {
        klasaEl.classList.add('input-error');
        hasError = true;
      }

      if (hasError) {
        showMessage('Popraw zaznaczone pola (dÅ‚ugoÅ›Ä‡ tekstu / klasa 1â€“8).', 'red');
        return; // NIE wysyÅ‚amy do Apps Script
      }

      submitBtn.disabled = true;
      submitBtn.classList.add('loading');
      submitBtn.textContent = 'âŒ› Zapisz';
      cancelBtn.disabled = true;

      const data = {
        id_zajecia: zajecie.id,
        nazwa: zajecie.nazwa,
        uczen,
        klasa: klasaNum.toString(),
        rodzic
      };

      google.script.run
        .withSuccessHandler(msg => {
         const isError = msg.startsWith('BÅ‚Ä…d') || msg.startsWith('âŒ');
          showMessage(msg, isError ? 'red' : 'green');
          drawer.remove();
          overlay.remove();
          google.script.run.withSuccessHandler(render).getZajeciaList();
        }).withFailureHandler(err => {
          showMessage('BÅ‚Ä…d: ' + err.message, 'red');
          google.script.run.withSuccessHandler(render).getZajeciaList();
        })
        .zapiszDziecko(data);
 }; // END



    }
  </script>
</body>
</html>
