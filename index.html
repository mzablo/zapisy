<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikacja do zapisÃ³w na zajÄ™cia dodatkowe</title>
  <?!= include('style') ?>
</head>
<body>
  <div class="container mt-3">
    <h1>ğŸ“… Lista zajÄ™Ä‡ dodatkowych</h1>
    <div id="container">Åadowanie zajÄ™Ä‡...</div>
  </div>

  <script>
    // Pobranie danych z Apps Script
    google.script.run.withSuccessHandler(render).getZajeciaList();

    function render(data) {
      const container = document.getElementById('container');
      container.innerHTML = ''; // czyÅ›cimy napis "Åadowanie"

      if (!data || data.length === 0) {
        container.textContent = 'Brak zajÄ™Ä‡ do wyÅ›wietlenia.';
        return;
      }

      const refreshBtn = document.createElement('button');
        refreshBtn.textContent = 'ğŸ”„ OdÅ›wieÅ¼ listÄ™';
        refreshBtn.onclick = () => {
          container.innerHTML = 'OdÅ›wieÅ¼anie...';
          google.script.run.withSuccessHandler(render).getZajeciaList();
        };
        container.appendChild(refreshBtn);

      // Grupowanie zajÄ™Ä‡ po dniach
      const grouped = {};
      data.forEach(z => {
        if (!grouped[z.dzien]) grouped[z.dzien] = [];
        grouped[z.dzien].push(z);
      });

      Object.keys(grouped).forEach(dzien => {
        const daySection = document.createElement('div');
        daySection.className = 'day-section';

        const title = document.createElement('h2');
        title.textContent = dzien;
        daySection.appendChild(title);

        const grid = document.createElement('div');
        grid.className = 'grid';

        grouped[dzien].forEach(z => {
          const card = document.createElement('div');
          card.className = 'card';

          card.innerHTML = `
            <h3>${z.nazwa}</h3>
            <p><strong>â°</strong> ${z.godzina_od} â€“ ${z.godzina_do}</p>
            <p><strong>ğŸ“ Klasa:</strong> ${z.klasa}</p>
            <p><strong>IloÅ›Ä‡ dostÄ™pnych miejsc:</strong> ${z.ileDostepnych}</p>
            <p class='invisible'>max: ${z.max_limit} min:${z.min_limit} ile: ${z.ileZapisanych} </p>
            <p class="${z.czyUruchomione ? 'run' : 'not_run'}">
              ${z.czyUruchomione ? 'ZajÄ™cie zostanie uruchomione': 'Brak minimalnej iloÅ›ci uczestnikÃ³w'}
            </p>
            <p class="${z.platne ? 'paid' : 'free'}">
              ${z.platne ? 'ğŸ’° PÅ‚atne' : 'âœ… BezpÅ‚atne'}
            </p>
          `;

          const button = document.createElement('button');
          button.textContent = z.ileDostepnych > 0 ? 'âœ… Zapisz dziecko' : 'âŒ Brak miejsc';
          button.disabled = z.ileDostepnych <= 0;
          button.className = z.ileDostepnych > 0 ? '' : 'disabled';
          if (z.ileDostepnych > 0) {
          button.onclick = () => openDrawer(z);
          }
          card.appendChild(button);
          grid.appendChild(card);
        });

        daySection.appendChild(grid);
        container.appendChild(daySection);
      });
    }

    // Funkcja do pokazywania komunikatÃ³w
    function showMessage(msg, color = 'green') {
      const oldMsg = document.getElementById('custom-message');
      if (oldMsg) oldMsg.remove();

      const div = document.createElement('div');
      div.id = 'custom-message';
      div.style.position = 'fixed';
      div.style.bottom = '20px';
      div.style.right = '20px';
      div.style.background = color;
      div.style.color = 'white';
      div.style.padding = '15px 20px';
      div.style.borderRadius = '8px';
      div.style.boxShadow = '0 0 10px rgba(0,0,0,0.3)';
      div.style.zIndex = 2000;
      div.textContent = msg;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    // Funkcja drawer
    function openDrawer(zajecie) {
      const overlay = document.createElement('div');
      overlay.className = 'drawer-overlay active';

      const drawer = document.createElement('div');
      drawer.className = 'drawer open';
     drawer.innerHTML = `
      <h3>Zapis na: ${zajecie.nazwa}</h3>
      
      <label>ImiÄ™ i nazwisko dziecka
        <input type="text" id="uczen" required>
      </label>
      
      <label>Klasa
        <input type="text" id="klasa" required>
      </label>
      
      <label>ImiÄ™ i nazwisko rodzica
        <input type="text" id="rodzic" required>
      </label>
      
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button id="submitForm" style="background: #1976d2; flex: 1;">âœ… Zapisz</button>
        <button id="cancelForm" style="background: #aaa; flex: 1;">âŒ Anuluj</button>
      </div>
    `;

      document.body.appendChild(overlay);
      document.body.appendChild(drawer);

      overlay.onclick = () => { drawer.remove(); overlay.remove(); };
      document.getElementById('cancelForm').onclick = () => { 
        drawer.remove(); overlay.remove();
        google.script.run.withSuccessHandler(render).getZajeciaList();
        };
      document.getElementById('submitForm').onclick = () => {
        const data = {
          id_zajecia: zajecie.id,
          nazwa: zajecie.nazwa,
          uczen: document.getElementById('uczen').value.trim(),
          klasa: document.getElementById('klasa').value.trim(),
          rodzic: document.getElementById('rodzic').value.trim()
        };
        google.script.run.withSuccessHandler(msg => {
          showMessage(msg);
          drawer.remove();
          overlay.remove();
          google.script.run.withSuccessHandler(render).getZajeciaList();
        }).withFailureHandler(err => {
          showMessage('BÅ‚Ä…d: ' + err.message, 'red');
          google.script.run.withSuccessHandler(render).getZajeciaList();
        }).zapiszDziecko(data);
      };
    }
  </script>
</body>
</html>
